{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-chart-line me-2"></i>
        System Monitoring
    </h1>
    <div>
        <button class="btn btn-outline-secondary" onclick="refreshMetrics()">
            <i class="fas fa-sync-alt me-2"></i>
            Refresh
        </button>
    </div>
</div>

<!-- System Health Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card text-center">
            <div class="metric-value text-success" id="system-health">
                <i class="fas fa-heartbeat"></i>
            </div>
            <div class="metric-label">System Health</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card text-center">
            <div class="metric-value text-primary" id="active-jobs">-</div>
            <div class="metric-label">Active Jobs</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card text-center">
            <div class="metric-value text-info" id="queue-size">-</div>
            <div class="metric-label">Queue Size</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card text-center">
            <div class="metric-value text-warning" id="success-rate">-</div>
            <div class="metric-label">Success Rate</div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tasks me-2"></i>
                    Job Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h4 text-success" id="completed-jobs-metric">-</div>
                            <small class="text-muted">Completed</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h4 text-danger" id="failed-jobs-metric">-</div>
                            <small class="text-muted">Failed</small>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h4 text-primary" id="running-jobs-metric">-</div>
                            <small class="text-muted">Running</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h4 text-warning" id="pending-jobs-metric">-</div>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Performance
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Average Execution Time</span>
                            <strong id="avg-execution-time">-</strong>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Total Jobs Processed</span>
                            <strong id="total-jobs-processed">-</strong>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <span>Last Sync Time</span>
                            <strong id="last-sync-time">-</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Component Status -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-server me-2"></i>
                    Component Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center p-3">
                            <div class="status-indicator mb-2" id="orchestrator-status"></div>
                            <h6>Orchestrator</h6>
                            <small class="text-muted" id="orchestrator-details">-</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3">
                            <div class="status-indicator mb-2" id="datasphere-status"></div>
                            <h6>SAP Datasphere</h6>
                            <small class="text-muted" id="datasphere-details">-</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3">
                            <div class="status-indicator mb-2" id="glue-status"></div>
                            <h6>AWS Glue</h6>
                            <small class="text-muted" id="glue-details">-</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3">
                            <div class="status-indicator mb-2" id="mapper-status"></div>
                            <h6>Asset Mapper</h6>
                            <small class="text-muted" id="mapper-details">-</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Log Stream -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-stream me-2"></i>
                    Recent Activity
                </h5>
            </div>
            <div class="card-body">
                <div id="activity-log" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Loading recent activity...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // API helper function (ensure it's available)
    async function apiCall(url, options = {}) {
        try {
            const response = await fetch(url, {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error('API call failed:', error);
            throw error;
        }
    }
    
    // Utility functions
    function formatDateTime(dateString) {
        if (!dateString) return 'Never';
        const date = new Date(dateString);
        return date.toLocaleString();
    }
    
    function formatDuration(seconds) {
        if (!seconds || seconds === 0) return '0s';
        if (seconds < 60) {
            return `${Math.round(seconds)}s`;
        } else if (seconds < 3600) {
            return `${Math.floor(seconds / 60)}m ${Math.round(seconds % 60)}s`;
        } else {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
    }
    
    // Monitoring page variables
    let metricsData = {};
    let activityLog = [];
    
    // Initialize monitoring page
    document.addEventListener('DOMContentLoaded', function() {
        loadMetrics();
        loadSystemStatus();
        
        // Auto-refresh every 5 seconds
        setInterval(() => {
            loadMetrics();
            loadSystemStatus();
        }, 5000);
    });
    
    // Load system metrics
    async function loadMetrics() {
        try {
            const response = await apiCall('/api/metrics');
            metricsData = response;
            updateMetricsDisplay();
            
        } catch (error) {
            console.error('Failed to load metrics:', error);
        }
    }
    
    // Load system status
    async function loadSystemStatus() {
        try {
            const response = await apiCall('/api/status');
            updateComponentStatus(response);
            
        } catch (error) {
            console.error('Failed to load system status:', error);
        }
    }
    
    // Update metrics display
    function updateMetricsDisplay() {
        if (!metricsData) return;
        
        // System health overview
        document.getElementById('active-jobs').textContent = metricsData.running_jobs || 0;
        document.getElementById('queue-size').textContent = metricsData.pending_jobs || 0;
        
        const successRate = metricsData.success_rate || 0;
        document.getElementById('success-rate').textContent = `${Math.round(successRate * 100)}%`;
        
        // Job statistics
        document.getElementById('completed-jobs-metric').textContent = metricsData.completed_jobs || 0;
        document.getElementById('failed-jobs-metric').textContent = metricsData.failed_jobs || 0;
        document.getElementById('running-jobs-metric').textContent = metricsData.running_jobs || 0;
        document.getElementById('pending-jobs-metric').textContent = metricsData.pending_jobs || 0;
        
        // Performance metrics
        document.getElementById('avg-execution-time').textContent = formatDuration(metricsData.average_execution_time);
        document.getElementById('total-jobs-processed').textContent = metricsData.total_jobs || 0;
        document.getElementById('last-sync-time').textContent = formatDateTime(metricsData.last_sync_time);
    }
    
    // Update component status
    function updateComponentStatus(statusData) {
        if (!statusData || !statusData.components) return;
        
        const components = statusData.components;
        
        // Orchestrator
        updateComponentIndicator('orchestrator-status', components.orchestrator?.status);
        document.getElementById('orchestrator-details').textContent = 
            `${components.orchestrator?.active_jobs || 0} active, ${components.orchestrator?.queue_size || 0} queued`;
        
        // Datasphere
        updateComponentIndicator('datasphere-status', components.datasphere_connector?.status);
        document.getElementById('datasphere-details').textContent = 
            components.datasphere_connector?.status === 'connected' ? 'Connected' : 'Disconnected';
        
        // Glue
        updateComponentIndicator('glue-status', components.glue_connector?.status);
        document.getElementById('glue-details').textContent = 
            components.glue_connector?.status === 'connected' ? 'Connected' : 'Disconnected';
        
        // Asset Mapper
        updateComponentIndicator('mapper-status', components.asset_mapper?.status);
        document.getElementById('mapper-details').textContent = 
            `${components.asset_mapper?.profiles_count || 0} profiles`;
    }
    
    // Update component status indicator
    function updateComponentIndicator(elementId, status) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        element.className = 'status-indicator mb-2';
        
        switch (status) {
            case 'running':
            case 'connected':
                element.classList.add('status-healthy');
                break;
            case 'not_connected':
            case 'disconnected':
                element.classList.add('status-error');
                break;
            default:
                element.classList.add('status-warning');
        }
    }
    
    // Refresh metrics manually
    function refreshMetrics() {
        loadMetrics();
        loadSystemStatus();
        
        // Show notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 80px; right: 20px; z-index: 1050; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-sync-alt me-2"></i>
            Metrics refreshed
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }
    
    // Update metrics from WebSocket (called from base template)
    function updateMetrics(data) {
        metricsData = data;
        updateMetricsDisplay();
    }
</script>
{% endblock %}